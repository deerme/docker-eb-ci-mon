container_commands:
    00_download_package:
        command: "wget https://dl.influxdata.com/telegraf/releases/telegraf-1.6.0-1.x86_64.rpm -O /tmp/telegraf.rpm"
        ignoreErrors: true
    01_install_package:
        command: "yum localinstall -y /tmp/telegraf.rpm"
        ignoreErrors: true
    02_remove_package:
        command: "rm /tmp/telegraf.rpm"
        ignoreErrors: true
    03_enable_reboot:
        command: "chkconfig telegraf on"
        ignoreErrors: true
    04_start_telegraf:
        command: "service telegraf start"
        ignoreErrors: true

files:
    /etc/telegraf/telegraf.conf:
        mode: "000600"
        owner: root
        group: root
        content: |
            [global_tags]
            hostname="Avengers"

            # Read metrics about CPU usage
            [[inputs.cpu]]
            percpu = false
            totalcpu = true
            fieldpass = [ "usage*" ]
            name_suffix = "_vm"

            # Read metrics about disk usagee
            [[inputs.disk]]
            fielddrop = [ "inodes*" ]
            mount_points=["/"]
            name_suffix = "_vm"

            # Read metrics about network usage
            [[inputs.net]]
            interfaces = [ "eth0", "eth1" ]
            fielddrop = [ "icmp*", "ip*", "tcp*", "udp*" ]
            name_suffix = "_vm"

            # Read metrics about memory usage
            [[inputs.mem]]
            name_suffix = "_vm"

            # Read metrics about swap memory usage
            [[inputs.swap]]
            name_suffix = "_vm"

            # Read metrics about system load and uptime
            [[inputs.system]]
            name_suffix = "_vm"

            # Read metrics from docker socket api
            [[inputs.docker]]
            endpoint = "unix:///var/run/docker.sock"
            container_names = []
            name_suffix = "_docker"

            [[outputs.influxdb]]
            database = "instances"
            urls = ["http://172.31.38.51:8086"]
            namepass = ["*_vm"]

            [[outputs.influxdb]]
            database = "containers"
            urls = ["http://172.31.38.51:8086"]
            namepass = ["*_docker"]

container_commands:
    00_restart_telegraf:
        command: "service telegraf restart"
        ignoreErrors: true